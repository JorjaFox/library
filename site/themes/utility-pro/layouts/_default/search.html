{{ partial "header.html" . }}

	{{ .Content }}

	<script>
	function getParameterByName(name, url) {
		if (!url) url = window.location.href;
		name = name.replace(/[\[\]]/g, "\\$&");
		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
		 results = regex.exec(url);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));
	}
	var searchQuery = getParameterByName('query');
	document.getElementById("searchbox").value = searchQuery;
	</script>

	<h3>Search:</h3>
	<label for="search-box">Search</label>
	<input type="text" id="search-box" name="query">
	<input type="submit" value="search">

	<h3>Results:</h3>
	<ul id="search-results"></ul>

	<script type="text/javascript" src="/library/js/lunr.js"></script>
	<script type="text/javascript">
	var lunrIndex, $results, pagesIndex;

		function getQueryVariable(variable) {
			var query = window.location.search.substring(1);
			var vars = query.split('&');

			for (var i = 0; i < vars.length; i++) {
				var pair = vars[i].split('=');

				if (pair[0] === variable) {
					return decodeURIComponent(pair[1].replace(/\+/g, '%20'));
				}
			}
		}

		var searchTerm = getQueryVariable('query');

	    // Initialize lunrjs using our generated index file
	    function initLunr() {
	        // First retrieve the index file
	        $.getJSON("/library/js/lunr/search.json")
	            .done(function(index) {
	                pagesIndex = index;
	                console.log("index:", pagesIndex);
	
	                // Set up lunrjs by declaring the fields we use
	                // Also provide their boost level for the ranking
	                lunrIndex = lunr(function() {
	                    this.ref("uri");
	                    this.field("title", { boost: 10 });
	                    this.field("tags", { boost: 5 });
	                    this.field("categories", { boost: 5 });
	                    this.field("content");
	
						pagesIndex.forEach(function (page) {
							this.add(page)
						}, this)
	                });
	            })
	            .fail(function(jqxhr, textStatus, error) {
	                var err = textStatus + ", " + error;
	                console.error("Error getting Hugo index flie:", err);
	            });
	    }

		if (searchTerm) {
			document.getElementById('search-box').setAttribute("value", searchTerm);

			for (var key in window.store) { // Add the data to lunr
				lunrIndex.add({
					'uri': key,
					'title': window.store[key].title,
					'tags': window.store[key].tags,
					'cateogries': window.store[key].cateogries,
					'content': window.store[key].content
				});
				var results = search(searchTerm); // Get lunr to perform a search
				displaySearchResults(results, window.store); // We'll write this in the next section
			}
		}

	function displaySearchResults(results, store) {
	  var searchResults = document.getElementById('search-results');

	  if (results.length) { // Are there any results?
		var appendString = '';

		for (var i = 0; i < results.length; i++) {  // Iterate over the results
			var item = store[results[i].ref];
			appendString += '<li><a href="' + item.url + '"><h3>' + item.title + '</h3></a>';
			appendString += '<p>' + item.content.substring(0, 150) + '...</p></li>';
		}

		searchResults.innerHTML = appendString;
	  } else {
		searchResults.innerHTML = '<li>No results found</li>';
	  }
	}

	// Let's get started
	initLunr();

	$(document).ready(function() {
		initUI();
	});
	</script>
{{ partial "footer.html" . }}
